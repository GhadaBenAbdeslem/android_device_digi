ifeq (,$(filter true, $(TARGET_NO_KERNEL) $(TARGET_NO_RECOVERY)))

MKIMAGE := $(HOST_OUT_EXECUTABLES)/mkimage$(HOST_EXECUTABLE_SUFFIX)

INSTALLED_URAMDISK_RECOVERY_TARGET := $(PRODUCT_OUT)/uramdisk-recovery.img

# 1KB blocks for mkfs.vfat
RECOVERYIMAGE_BLOCKS := $(shell expr $(BOARD_RECOVERYIMAGE_PARTITION_SIZE) / 1024)

# Recovery image included files
RECOVERYIMAGE_FILES := $(KERNEL_BIN)
RECOVERYIMAGE_FILES += $(KERNEL_DTBS)
RECOVERYIMAGE_FILES += $(INSTALLED_BOOTSCRIPT_TARGET)
RECOVERYIMAGE_FILES += $(INSTALLED_URAMDISK_RECOVERY_TARGET)

# Temporary file to create the recovery image
RECOVERYIMAGE_TMPFILE := $(shell mktemp -u $(INSTALLED_RECOVERYIMAGE_TARGET).XXXXXX)

$(INSTALLED_RECOVERYIMAGE_TARGET): $(KERNEL_DTBS_MAKETARGET) $(INSTALLED_BOOTSCRIPT_TARGET) | $(IMG2SIMG)
	$(call pretty,"Target DEA recovery image: $@")
	$(call build-recoveryimage-target, $@)
	$(MKIMAGE) -A $(TARGET_ARCH) -O linux -T ramdisk -n "Android U-Boot recovery ramdisk" -d $(recovery_ramdisk) $(INSTALLED_URAMDISK_RECOVERY_TARGET)
	rm -f $@ && mkfs.vfat -a -n "RECOVERY" -S 512 -C $(RECOVERYIMAGE_TMPFILE) $(RECOVERYIMAGE_BLOCKS)
	$(FAT16COPY) $(RECOVERYIMAGE_TMPFILE) $(RECOVERYIMAGE_FILES)
ifeq ($(strip $(TARGET_DEA_SPARSE_VFAT_IMAGES)),true)
	$(IMG2SIMG) $(RECOVERYIMAGE_TMPFILE) $@ && rm -f $(RECOVERYIMAGE_TMPFILE)
else
	mv $(RECOVERYIMAGE_TMPFILE) $@
endif

endif
